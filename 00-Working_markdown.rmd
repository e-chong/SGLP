---
title: "SGLP Working Draft"
author: "Eugene Chong"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
cache_state = TRUE
eval_state = FALSE # use this for testing chunks that should/should not be run in the final knit doc

opts_chunk$set(echo = TRUE, cache = cache_state, message = FALSE)
knit_hooks$set(optipng = hook_optipng)
```

# Admin

Load packages

```{r packages}
source("~scripts/00 - Admin.R") 
source("~scripts/01 - Utility Functions.R")

# unload packages
# detach("package:microbenchmark", unload=TRUE)
```

# Read Data

## Siegel data for all cities

```{r}
source("~scripts/10 - Read Siegel Data.R")
```

## Gun incidents for all cities

```{r, eval = eval_state}
# source("~scripts/11 - Read crime data.R")
guns_df <- readRDS("~outputs/10/11_guns_df.rds")
```

```{r}
# source("~scripts/21 - Clean crime data.R")
guns_clean <- readRDS("~outputs/20/21_guns_clean.rds")
guns_list <- readRDS("~outputs/20/21_guns_list.rds")
```

Sample of data for testing

```{r, eval = eval_state}
set.seed(1)
guns_sample_df <- sample_n(guns_df, 10000) 
guns_sample_ls <- guns_sample_df %>% 
  split(., # split into nested list of dfs by city
        f = .$city)
```

## Census data for all cities

```{r, results = "hide"}
source("~scripts/12 - Read census data.R")
```

# Explore Data

## Siegel

Date range: 1991-2019

```{r}
range(siegel_raw$year)
```

134 different laws...

```{r}
unique(siegel_raw$law)
```

Organized into 14 categories...

```{r}
unique(siegel_raw$Category)
```

And 50 sub-categories

```{r}
unique(siegel_raw$Sub.Category)
```

## Gun Crimes

Number of Cities: 34
Number of States: 29

```{r}
unique(guns_clean$city)
unique(guns_clean$state)
```

**Date Range:**

* Occurrence Date: 06/19/1922 - 05/01/2020
* Report Date: 10/03/1960 - 05/01/2020

```{r, eval = eval_state}
plan(multiprocess)
guns_sample_ls <- future_map(guns_sample_ls,
                        ~ .x %>% 
                          mutate(clean_occur_date = anydate(occurdate), # use built-in formats from anytime package
         # correct some incorrectly parsed observations
         clean_occur_date = case_when(occurdate == "1" ~ as.Date(NA),
                                      clean_occur_date < as.Date("1900-01-01") ~ as.Date(NA), 
                                      is.na(clean_occur_date) & 
                                        str_detect(occurdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(occurdate, "%m/%d/%y"),
                                      TRUE ~ clean_occur_date),
         clean_report_date = anydate(reportdate),
         clean_report_date = case_when(reportdate == "1" ~ as.Date(NA),
                                       clean_report_date < as.Date("1900-01-01") ~ as.Date(NA),
                                       is.na(clean_report_date) & 
                                        str_detect(reportdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(reportdate, "%m/%d/%y"),
                                      TRUE ~ clean_report_date)))
```

```{r}
range(guns_clean$clean_occur_date, na.rm = TRUE)
range(guns_clean$clean_report_date, na.rm = TRUE)
```

Benchmarking results show `furrr` is fastest for manipulating the data.
```{r, eval = eval_state}
benchmark_results <- benchmark("flat" = {
  flat <- guns_sample_df %>% 
  mutate(clean_occur_date = anydate(occurdate), # use built-in formats from anytime package
         # correct some incorrectly parsed observations
         clean_occur_date = case_when(occurdate == "1" ~ as.Date(NA),
                                      is.na(clean_occur_date) & 
                                        str_detect(occurdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(occurdate, "%m/%d/%y"),
                                      TRUE ~ clean_occur_date),
         clean_report_date = anydate(reportdate),
         clean_report_date = case_when(is.na(clean_report_date) & 
                                        str_detect(reportdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(reportdate, "%m/%d/%y"),
                                      TRUE ~ clean_report_date))}, # benchmarking shows the furrr approach is fastest (but still not very fast)

"purrr" = {map(guns_sample_ls,
                        ~ .x %>% 
                          mutate(clean_occur_date = anydate(occurdate), # use built-in formats from anytime package
         # correct some incorrectly parsed observations
         clean_occur_date = case_when(occurdate == "1" ~ as.Date(NA),
                                      is.na(clean_occur_date) & 
                                        str_detect(occurdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(occurdate, "%m/%d/%y"),
                                      TRUE ~ clean_occur_date),
         clean_report_date = anydate(reportdate),
         clean_report_date = case_when(is.na(clean_report_date) & 
                                        str_detect(reportdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(reportdate, "%m/%d/%y"),
                                      TRUE ~ clean_report_date)))},

# plan(multiprocess)
"furrr" = {future_map(guns_sample_ls,
                        ~ .x %>% 
                          mutate(clean_occur_date = anydate(occurdate), # use built-in formats from anytime package
         # correct some incorrectly parsed observations
         clean_occur_date = case_when(occurdate == "1" ~ as.Date(NA),
                                      is.na(clean_occur_date) & 
                                        str_detect(occurdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(occurdate, "%m/%d/%y"),
                                      TRUE ~ clean_occur_date),
         clean_report_date = anydate(reportdate),
         clean_report_date = case_when(is.na(clean_report_date) & 
                                        str_detect(reportdate,
                                                   ".*\\d+/\\d+/\\d+.*") ~ # e.g "12/3/15", "12/3/15 1600" 
                                        as.Date(reportdate, "%m/%d/%y"),
                                      TRUE ~ clean_report_date)))},
  replications = 1
)
```

### Plots

Data:

```{r}
# source("~scripts/21 - Clean crime data.R")
guns_list_shp <- readRDS("~outputs/20/21_guns_list_shp.rds")
```

Source script: 

```{r}
source("~scripts/31 - Explore crime data.R") 
```

Crime counts by city

```{r}
gunIncident_summary %>% 
  arrange(desc(prop)) %>% 
  kable() %>% 
  kable_styling()
```

```{r, optipng='-o7', fig.height=6}
gunIncidentsByCityPlot
```

How many NA observations?

```{r}
na_coords_summary <- map(guns_list,
                            ~ sum(is.na(.x$lon) | is.na(.x$lat)) /
                              nrow(.x)) %>% 
  bind_rows() %>% 
  gather(key = "City",
         value = "pct_NA")
```

```{r}
na_coords_summary %>% 
  arrange(desc(pct_NA)) %>% 
  kable() %>% 
  kable_styling()
```

Map of all incidents in San Francisco with coordinates

```{r, optipng='-o7', fig.height = 6}
sf_incident_map
```

#### All Cities

##### Maps of each city  {.tabset}

```{r, optipng='-o7', results='asis', echo = FALSE}
tmp <- list.files("~outputs/Plots/31a_gunCrimes",
                  full.names = TRUE)

for (i in 1:length(tmp)) {
  cat("###### ",names(guns_list[i]),"\n")
  cat(paste0("![](", tmp[i], "){width=65%}"), "\n")
  cat('\n\n')
}
```


#### Next section
